<!--

	@author: Arijit Saha
	@desc: Html serving user bookings page
	@file path from root: Ex ./my_bookings.html

    @edited: Monidepa Ghosh
    @desc: made necessary changes in the header and footer and added my profile

-->



<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./index.css" />
    <link rel="stylesheet" href="./home.css" />
    <link rel="stylesheet" href="./my_bookings.css"/>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <title>Document</title>
</head>
<body>

    <div class="main">
        <!-- Header -->
        <div class="header">

            <!-- <div class="header-div">
                <div class="nri-travel">NRI Travel</div>

            </div> -->
            <div class="header-div">

                <a href="index.html" class="nrifintech">
                    <div> NRI TRAVEL</div>
                </a>
                
            </div>
            <div class="header-end">

                <!--Monidepa Ghosh-->

                <div class="header-end-items">
                    <p class="header-end-items-text"> 
                        <a href="my_profile.html" class="profile">  My Profile  </a>
                    </p>     
                </div>

                        <div class="header-end-items">
                            <img class="vector-icon" alt="" src="public/vector2.svg" />
                            <p class="header-end-items-text"> 
                                <a href="my_bookings.html" class="booking">  Booking  </a>
                            </p>     
                        </div>

                        <div class="header-end-items">
                                <img class="vector-icon" alt="" src="public/vector1.svg" />
                                <p class="header-end-items-text"> 
                                    <a href="" class="logout"> Logout  </a>  
                                </p>
                        </div>
                
            </div>
        </div>

        <!-- Body -->
        <div class="body-part">
            
                    <div>

                        <!--

                            Write your body code within this div

                            Remove the Lorem text to add your code
                            
                             -->

                             <div class="body-part-maindiv">


                                    <div class="my-booking-div">
                                        <div class="my-booking-div-text">My Bookings</div>
                                        <div class="my-booking-icon-div"> <img  src="./public/down-icon.svg" alt=""> </div>
                                    </div>
                                    

                                    <div class="content">

                                
                             </div>


                    </div>
            
           
                        
            </div>

        <!-- Footer -->
        <div class="footer">

            <div class="footer-element">
                NRI includes a copyright notice that reserves all rights for itself,
                and has protected material
            </div>
            <div class="footer-element-smallerscreen">
                All rights reserved by NRI
            </div>
        </div>
    
    </div>


    <!-- 
        *****   OverLays   ****** 
    -->

    <!-- Cancel Overlay -->

    <div class="cancel-overlay" onclick="off()">
        <div class="cancel-div">
            
            <div class="cancel-overlay-main-div">

                <div class="cancel-text">Are you sure you want to cancel your booking ?</div>
                <div class="confirm-cancel-buttons">
                    <button class="confirm-button"> <img class="confirm-cancel-icon" src="./public/confirm-icon.svg" alt=""> Confirm</button>
                    <button class="cancel-button"> <img class="confirm-cancel-icon" src="./public/cancel-icon.svg" alt=""> Cancel</button>
                </div>

            </div>

        </div>
    </div>

    <!-- Cancel Overlay Ends Here-->


    <!-- Routes Overlay -->

    <div class="route-overlay" onclick="offroute()">
        <div class="route-div"> 
            <div class="route-overlay-main-div">

                <!-- Cross div -->
                <div class="route-overlay-crossdiv">
                    <img class="route-cross-icon" src="./public/route-overlay-cancel-icon.svg" alt="">
                </div>
                <!-- Cross div ends here -->
                
                <div class="route-overlay-main-div-elements-div">
                    <div class="route-overlay-time">8:00 am </div> 
                    <img class="route-overlay-icon" src="./public/route-overlay-icon.svg" alt=""> 
                    <div class="route-overlay-place">Ultodanga</div>
                </div>

                <div class="route-overlay-main-div-elements-div">
                    <div class="route-overlay-time">8:15 am </div> 
                    <img class="route-overlay-icon" src="./public/route-overlay-icon.svg" alt=""> 
                    <div class="route-overlay-place">Sapoorji</div>
                </div>

                <div class="route-overlay-main-div-elements-div">
                    <div class="route-overlay-time">8:30 am </div> 
                    <img class="route-overlay-icon" src="./public/route-overlay-icon.svg" alt=""> 
                    <div class="route-overlay-place">Saltlake</div>
                </div>

                <div class="route-overlay-main-div-elements-div">
                    <div class="route-overlay-time">8:45 am </div> 
                    <img class="route-overlay-icon" src="./public/route-overlay-icon.svg" alt=""> 
                    <div class="route-overlay-place">Chingrighata</div>
                </div>

                <div class="route-overlay-main-div-elements-div">
                    <div class="route-overlay-time">9:00 am </div> 
                    <img class="route-overlay-icon" src="./public/route-overlay-icon.svg" alt=""> 
                    <div class="route-overlay-place">Nri Fintech</div>
                </div>

            </div>
        </div>
    </div>
    <!-- Routes OverLay End here -->

    <!-- 
        ******* Overlays End Here *******
    -->

    <script src="./index.js">
    </script>

</body>
</html>
<script>
    $(document).ready(function(){
        //Change it the user that is calling
        $.get("http://localhost:8080/api/v1/ticket/get/1",function(data){
            // "id": 28,
            // "routeId": 5,
            // "busId": 4,
            // "userId": 1,
            // "status": "CANCELLED",
            // "date": "09:03:2023"
            for(var i = 0;i<data.length;i++){
			const route_id = data[i].routeId;
            const ticket_id = data[i].id;
            const formattedDate = data[i].date;
            const status = data[i].status;
			const obj = {
				busId:"",
				busName:"",
				busNumber:"",
				destination_name:"",
				destination_time:"",
				route_id:"",
				source_name:"",
				source_time:"",
				userId:1, //To be changed
			};
			obj["route_id"] = route_id;
			$.get("http://localhost:8080/api/v1/route/getDestinations/" + route_id,function(data){
				console.log(data);
				obj["source_name"] = data[0].destination.name;
				obj["source_time"] = data[0].time;

				obj["destination_name"] = data[data.length - 1].destination.name;
				obj["destination_time"] = data[data.length - 1].time;

				$.get("http://localhost:8080/api/v1/route/getReport/" + route_id + "/" + formattedDate,function(data){
				var diff = data.total_seats - data.total_bookings;
				obj["seatsLeft"] = max(0,diff);
				$.get("http://localhost:8080/api/v1/route/getBus/" + route_id,function(data){
					obj["busName"] = data.name;
					obj["busId"] = data.id;
					obj["busNumber"] = data.bus_number;

					//To be changed
					obj["userId"] = 1;
					console.log(obj);

					const routeHTML = `
									<div class="content-element">

									<div class="content-element-main">
										<div class="content-element-main-divs">
										<div class="bus-name-div">
											<div class="bus-icon"><img src="./public/vector4.svg" alt=""></div>
											<div class="bus-name-text">${obj.busName}</div>
										</div>
										<div class="bus-no">${obj.busNumber}</div>
										</div>
										<div class="content-element-main-divs pickup-drop">
										<div class="pickup-div">
											<div class="location-icon"><img class="location-icon-img" src="./public/placeholder-14@2x.png" alt=""></div>
											<div class="pickup-text">Pickup</div>
										</div>
										<div class="pickup-location-text">${obj.source_name}</div>
										<div class="pickup-time-text">${obj.source_time}</div>
										</div>
										<div class="content-element-main-divs pickup-drop">
										<div class="drop-div">
											<div class="location-icon"><img class="drop-icon-img" src="./public/placeholder-14@2x.png" alt=""></div>
											<div class="drop-location">Drop</div>
										</div>
										<div class="drop-location-text">${obj.destination_name}</div>
										<div class="drop-time-text">${obj.destination_time}</div>
										</div>
                                        <div class="content-element-main-divs seats-left"> 
                                                        
                                                        <div class="status-div"> 
                                                            <div class="status-text" > Status </div> 
                                                        </div>
                                                        <div  class="confirmed-text">  ${status} 

                                                        </div>   
                                                    </div> 
										<div class="content-element-main-divs">
										<div class="see-route-div" onclick="homeonroute()">
											<div class="route-icon"><img src="./public/route-icon.svg" alt=""></div>
											<div class="see-route-text">See Route</div>
										</div>
                                        <div class="cancel-btn" ticket_id = ${ticket_id} onclick="cancelTicket(event)">  
                                                            Cancel
                                        </div>

										</div>
									</div>
									</div>
								`;
								const parentDiv = document.querySelector(".content");
								parentDiv.innerHTML += routeHTML;
				}).fail(function(){
					return alert("Server error! Please try again!")
				})
			}).fail(function(){
				return alert("Server error! Please try again!");
			});
			}).fail(function(){
				return alert("Server error! Please try again!");
			});
			
		
			
		
	}
        }).fail(function(){
            return alert("Something went wrong. Please try again later!");
        })
    })
    function cancelTicket(event){
        const ticket_id = $(event.target).attr("ticket_id");
        
$.ajax({
    type: "POST",
    url: "http://localhost:8080/api/v1/ticket/cancel",
    data: JSON.stringify(ticket_id),
    headers: {
        "Content-Type": "application/json"
    },
    success: function(response) {
        console.log("Ticket cancelled successfully");
        alert("Ticket cancelled sucessfully!");
        // Handle success response here
    },
    error: function(xhr, status, error) {
        console.log("Error cancelling ticket: " + error);
        alert("Server error! Please try again!");
        // Handle error response here
    }
});
    }
</script>